<?php

declare(strict_types=1);

namespace Mammatus\Cron\Generated;

use Mammatus\LifeCycleEvents\Boot;
use Mammatus\LifeCycleEvents\Shutdown;
use Psr\Container\ContainerInterface;
use Psr\Log\LoggerInterface;
use RuntimeException;
use Throwable;
use WyriHaximus\Broadcast\Contracts\AsyncListener;
use WyriHaximus\PSR3\ContextLogger\ContextLogger;
use WyriHaximus\React\Cron;
use WyriHaximus\React\Mutex\Contracts\MutexInterface;

/**
 * This class is generated by mammatus/cron, do not edit manually.
 * Or do, I'm not your parent, they will be overwritten next composer install/update ¯\_(ツ)_/¯.
 */
final class Manager implements AsyncListener
{
    private ?Cron $cron = null;

    /** @phpstan-ignore ergebnis.noParameterWithContainerTypeDeclaration */
    public function __construct(
        private readonly LoggerInterface $logger,
        private readonly MutexInterface $mutex,
        private readonly ContainerInterface $container,
    ) {
    }

    public function start(Boot $event): void
    {
        $this->logger->debug('Starting cron manager');
        $this->cron($this->mutex);
        $this->logger->debug('Started cron manager');
    }

    public function stop(Shutdown $event): void
    {
        $this->logger->debug('Stopping cron manager');
        $this->cron($this->mutex)->stop();
        $this->logger->debug('Stopped cron manager');
    }

    private function perform(string $class): void
    {
        $logger = new ContextLogger($this->logger, ['cronjob' => $class]);
        try {
            $logger->debug('Getting job');
            $job = $this->container->get($class);
            if (! ($job instanceof \Mammatus\Cron\Contracts\Action)) {
                throw new RuntimeException('Given job is not an action');
            }

            $logger->debug('Starting job');
            $job->perform();
            $logger->debug('Job finished');
        } catch (Throwable $throwable) {
            $logger->error('Job errored', ['exception' => $throwable]);
        }
    }

    private function cron(MutexInterface $mutex): Cron
    {
        if ($this->cron instanceof Cron) {
            return $this->cron;
        }

        $this->cron = Cron::createWithMutex(
            $mutex,
            /** @see \Mammatus\DevApp\Cron\Noop */
            new Cron\Action(
                'cron_no.op',
                69,
                '* * * * *',
                fn () => $this->perform(\Mammatus\DevApp\Cron\Noop::class),
            ),
        );

        return $this->cron;
    }
}
